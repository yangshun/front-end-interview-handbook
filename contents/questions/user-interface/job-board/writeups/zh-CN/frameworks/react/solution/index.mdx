import TestCases from '../../../test-cases.mdx';
import Notes from '../../../notes.mdx';

## 解决方案

解决此问题的高级方法是将解决方案分解为更小的部分/步骤：

1. 获取所有工作 ID 的列表。
2. 使用工作 ID 列表，获取当前页面工作 ID 的工作详细信息。
3. 以卡片格式呈现工作数据。
4. 当按下“加载更多工作”按钮时，再次触发获取工作详细信息。

### 状态

该代码使用几个状态变量来管理应用程序的行为和数据流：

* `fetchingJobDetails`：跟踪当前是否正在从 API 获取工作详细信息。它用于禁用“加载更多”按钮，并在获取过程中向用户提供反馈。
* `page`：当前页码，它决定要获取哪一组工作 ID 和详细信息。当用户单击“加载更多”按钮时，它会递增。
* `jobIds`：从 Hacker News API 检索的工作 ID 数组。它最初设置为 `null`，稍后使用来自 API 的数据填充。它允许分页并根据 ID 获取工作详细信息。
* `jobs`：维护一个包含工作对象（如工作标题、作者、时间和 URL）的数组。它最初是一个空数组，并在从 API 获取工作详细信息时更新。

### 渲染

渲染代码的一些显著方面包括：

* 使用 CSS Grid 列出帖子：工作发布使用 `display: grid` CSS 属性以网格布局显示。这是一种允许工作发布之间保持一致间距的便捷方法。
* “加载更多”按钮的样式：使用特定的背景颜色、边框和填充来设置“加载更多”按钮的样式，使其在视觉上突出。该按钮在悬停时也会更改颜色，以便向用户提供视觉反馈。

### 获取数据

#### `fetchJobIds`

此异步方法负责从 Hacker News API 获取当前页面的工作 ID 列表，并以当前页码作为参数调用。

由于 API 只有一个用于获取所有热门工作列表的端点，因此我们只需要获取列表一次，并通过向 API 端点发出 `GET` 请求将其保存为状态中的 `jobIds`。检索到工作 ID 后，它会根据当前页面对数组进行切片，并返回相关的工作 ID 子集。对该函数的后续调用将只是对数组进行切片，而无需再次获取数据。

#### `fetchJobs`

此异步方法根据从 `fetchJobIds` 方法获得的工作 ID 获取工作详细信息。它以当前页码作为参数调用。在方法内部，它调用 `fetchJobIds(currPage)` 以获取当前页面的工作 ID，然后将 `fetchingJobDetails` 状态变量设置为 `true` 以指示正在获取工作详细信息。使用 `Promise.all`，它向 Hacker News API 发出多个 GET 请求以获取每个工作的详细信息，使用当前页面的工作 ID。获得工作详细信息后，它通过将新获取的工作附加到现有工作来更新 `jobs` 状态变量。最后，它将 `fetchingJobDetails` 设置回 false，以指示获取过程已完成。

`useEffect` 钩子负责在 `page` 状态变量更改时触发 `fetchJobs` 方法。它确保当页面编号更新时（例如，当用户单击“加载更多”按钮时），将调用 `fetchJobs` 方法以获取新页面的相应工作详细信息。建议使用 `useEffect` 将工作详细信息数据与当前页面同步，而不是在单击“加载更多”按钮时触发 `fetchJobs`，因为它很容易扩展到其他分页来源，例如无限滚动、其他分页按钮等。

在 React 中，[`useEffect`（因此 `fetchJobs`）在开发期间以严格模式在组件挂载时运行两次](https://react.dev/reference/react/useEffect#my-effect-runs-twice-when-the-component-mounts)。这是否意味着获取的工作详细信息被添加了两次到 jobs 数组中？值得庆幸的是，由于 `fetchJobs` 闭包中的 `jobs` 的值是相同的，因此生成的 `combinedJobs` 将是相同的，假设 API 的结果在请求之间保持不变。

### 处理竞态条件

处理异步请求时，可能会发生竞态条件，这可能导致错误：

1. 请求在组件卸载后完成。我们可以在 React 中使用 `ref` 来跟踪组件的挂载状态，并忽略在组件不再挂载后完成的请求。
2. 请求未按顺序返回。对于此应用程序，乱序请求通常不是问题，因为我们只允许一次获取一页作业。一页的作业详细信息是并行获取的，并且仅在所有请求完成后才添加。`fetchJobs` 被 `useEffect` 在挂载时调用两次存在竞争条件问题，但如上所述已处理。

<TestCases />

<Notes />
