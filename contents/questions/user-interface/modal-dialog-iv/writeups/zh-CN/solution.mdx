## 解决方案

我们将在 [Modal Dialog III 的解决方案](/questions/user-interface/modal-dialog-iii/solution) 的基础上进行构建。 就像在 Modal Dialog III 中一样，只需要添加交互；样式和结构可以保持不变。

需要实现以下行为：

1. 对话框打开时，聚焦到第一个可 Tab 元素
2. 焦点捕获 – 焦点被限制在对话框内，无法逃逸
3. 对话框关闭时，焦点返回到调用对话框的元素

### 1. 对话框打开时，聚焦到第一个可 Tab 元素

此功能实现起来非常简单。 在组件挂载时，查询所有元素并聚焦到第一个可 Tab 元素。 对话框内的可 Tab 元素可以使用以下选择器进行选择：

```js
dialogEl.querySelectorAll(
  'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])',
);
```

这被实现为 `useFocusOnFirstTabbableElement` hook。

### 2. 焦点捕获

焦点捕获是一种用于控制和管理网页或应用程序特定区域或组件（例如模态对话框、下拉菜单）内键盘焦点的技术。

实际上，实现了以下行为：

* 当焦点到达最后一个元素时，<kbd>Tab</kbd> 将焦点移动到第一个可 Tab 元素
* 当焦点位于第一个元素时，<kbd>Shift</kbd> + <kbd>Tab</kbd> 将焦点移动到最后一个可 Tab 元素
* 捕获区域内的所有交互元素保持可聚焦
* 捕获区域外的元素暂时变为不可聚焦

在非边界元素之间进行 Tab 切换可以保持正常。 只有第一个和最后一个元素需要特殊处理。 我们需要劫持这些边界元素上的 Tab 事件，并通过编程方式聚焦于所需的元素，而不是让浏览器来决定（这依赖于 DOM 顺序）。

我们可以向对话框添加一个 `keydown` 事件监听器，并过滤 <kbd>Tab</kbd> 事件的按下。 在回调中：

1. 如果当前聚焦的元素（通过 `document.activeElement`）是最后一个可 Tab 元素，并且按下了 <kbd>Tab</kbd> 键，则将焦点聚焦到第一个可 Tab 元素。
2. 如果当前聚焦的元素（通过 `document.activeElement`）是第一个可 Tab 元素，并且按下了 <kbd>Shift</kbd> + <kbd>Tab</kbd> 键（通过检查 `event.shiftKey` 属性），则将焦点聚焦到最后一个可 Tab 元素。

要找到所有可 Tab 元素，可以使用与第 1 部分相同的选择器。 请注意，建议在 <kbd>Tab</kbd> 键事件期间按需查找所有可 Tab 元素，而不是在对话框挂载时查找并保留对列表的引用。 这是因为对话框的内容可以随时修改； 挂载时可 Tab 元素的列表可能与用户实际通过它们进行 Tab 切换时不同。

在以编程方式更改焦点之前，请记住调用 `event.preventDefault()`，否则浏览器将继续执行默认行为 – 聚焦于由 DOM 顺序确定的下一个元素。

这被实现为 `useFocusTrap` hook。

### 3. 对话框关闭时，焦点返回到调用对话框的元素

可以使用 `document.activeElement` 获取页面上当前聚焦的元素。 当对话框挂载时，保存对该元素的引用（如果存在）。 在卸载时，以编程方式聚焦于该元素。

这被实现为`useReturnFocusToTrigger`钩子。需要注意的重要一点是，这个钩子必须在**`useFocusOnFirstTabbableElement`之前调用**，否则焦点将被设置在第一个可tab的元素上，甚至在这个钩子有机会保存对焦点触发器的引用之前。
