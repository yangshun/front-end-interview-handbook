import TestCases from '../../../test-cases.mdx';

**注意：**这是[进度条 III](/questions/user-interface/progress-bars-iii)的高级版本，在尝试此问题之前，您应该先完成该问题。

## 解决方案

该问题可以分为三个部分：(1) 状态，(2) 动画，和 (3) 交互。

### 状态

由于我们需要允许暂停和恢复动画，我们在之前的进度条问题中使用的简单状态将不再足够。我们需要能够跟踪每个条的完成百分比。

可以使用数值数组对进度条列表进行建模，其中每个值的范围是 0-100，表示该条的完成百分比。空进度条的初始状态将是`[0]`，两个完整的进度条由`[100, 100]`表示。

添加新条只需通过`Array.prototype.concat(0)`在数组末尾添加一个 0 即可。

### 动画

为了更好地控制动画，我们不能再依赖 CSS 过渡，而必须在 JavaScript 中使用`setTimeout`/`setInterval`浏览器 API。

将动画视为以固定间隔运行的循环会更容易。在每个循环中，我们可以将相关进度条的完成百分比增加一小部分，以给人一种平滑渐进动画的印象。

`setInterval`返回一个`timerId`值，我们将把它保存在一个状态变量中，以便在通过`setTimeout`停止动画时可以检索它。如果没有计时器运行，`timerId`的值将为`null`。为了使动画看起来流畅，我们应该选择一个低于 16 毫秒（对于 60fps 体验）的时间间隔。为了在 2000 毫秒内将一个条从 0 填充到 100，一种可能的组合是每 10 毫秒将完成百分比更新 0.5%。

### 交互

#### 开始

`start`函数通过`setInterval`启动计时器，该计时器以（几乎）固定的间隔触发回调。每次触发回调时，我们都会找到前 3 个未满的条，并将它们的值增加 0.5。

请注意，我们需要使用`setProgression`的回调形式，该形式接收更新后的`progression`值作为参数。这是必要的，因为`setProgression`回调的闭包将引用`progression`的过时版本，而`setProgression`的回调形式将为我们提供最新的`progression`值。

在惯用的 React 中，我们尽可能避免变异，因此我们首先复制`progression`数组（通过`slice()`），然后再变异未满进度条的索引。

如果我们找不到未满的进度条，则意味着所有条都已满，无需执行任何操作。

### 暂停

暂停很简单。我们取消任何现有的计时器，并将`timerId`设置为`null`。

### 添加新进度条

要添加新的空进度条，我们可以使用`progression.concat(0)`，它会克隆数组并在末尾添加0。

### 重置

只需将`progression`设置回初始值并调用`stop()`函数。

<TestCases />
