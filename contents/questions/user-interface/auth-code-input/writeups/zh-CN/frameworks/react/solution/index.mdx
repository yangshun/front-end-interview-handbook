import TestCases from '../../../test-cases.mdx';
import A11y from '../../../a11y.mdx';

## 解决方案

auth code 输入组件的复杂性在于用户体验、自定义输入处理和焦点管理：

*  代码被拆分成了 N 个 `<input>` 字段，而不是单个 `<input>`
*  焦点管理对于 auth code 输入组件来说非常难正确处理：
  *  输入值
    *  用户应该能够在不使用任何方向键的情况下输入值
    *  输入字段填满后，焦点应自动切换
  *  删除值
    *  用户应该能够仅使用 <kbd>Backspace</kbd> 键删除所有输入字段
    *  按下 <kbd>Backspace</kbd> 键应删除当前值。如果当前输入字段为空，它还应该聚焦于前一个值
  *  在字段之间切换
    *  应该可以使用常用的方向键和 <kbd>Tab</kbd> 键在输入字段之间切换
  *  当用户聚焦于输入字段时，他们希望能够输入新值 - 任何现有值都应该被替换，并且焦点应该移动到下一个字段

### 状态

不需要太多状态变量，因为复杂性在于焦点管理。

自然地，我们需要状态来存储代码。严格来说，可以使用不受控制的输入，但将输入值保留在状态中将使我们能够适当地启用/禁用“重置”和“提交”按钮。

有必要对哪个输入字段被聚焦进行细粒度控制，因此 `focusedIndex` 状态值将有所帮助。

因此，存在两个状态值：

*  `code`：此状态存储用户输入的 auth code，是一个字符串。
*  `focusedIndex`：此状态存储当前聚焦的输入字段的索引。

### 输入处理

在 React 中，人们可能没有注意到的 `<input>` 的 `onChange` 属性的一个行为是，**它仅在输入值发生变化时才会被触发**。对于此组件中的输入字段，即使用户在字段中输入相同的值，我们也希望响应按键事件，因为我们希望在输入有效数字后移动到下一个输入字段。

由于我们还需要处理其他键盘事件，如左/右箭头（移动到上一个/下一个字段）、退格键（删除当前值并移动到下一个字段），我们可以为 `keydown` 事件添加一个侦听器，该侦听器处理这些特殊键以及数字键。这是少数几个无需使用 `onChange` 回调即可响应输入的情况之一。这使我们能够忽略输入字段中的任何内容，替换为新值，并聚焦于下一个字段。

要处理以下键：

*  **左箭头**：将焦点移到当前聚焦的输入字段的左侧。
*  **右箭头**：将焦点移到当前聚焦的输入字段的右侧。
*  **退格键**：如果当前聚焦的输入字段已满，则将其删除。否则，将焦点移到上一个输入字段，并删除上一个输入字段中存在的任何字符。
*  **其他**：检查新输入的值是否有效。如果是，则更新 `code` 并将焦点移到下一个输入字段。

### 删除和替换值的便捷方式

通常，当聚焦于输入字段时，会在字段内创建一个光标以允许修改值。但是对于 auth code 输入，每个输入字段只允许一个数字，如果输入字段已满，则根本不渲染光标是没有意义的。如果用户分别通过 <kbd>Backspace</kbd> 键或新的数字键删除字段或用单个按键替换现有值，则会更有用。通过侦听 `keydown` 事件，我们可以像上一节中解释的那样做出适当的响应。使用 `onChange` 回调更难实现这一点。

### 粘贴值

通常，用户不会手动输入数字，而是从电子邮件或消息中复制 auth code 进行粘贴。因此，我们也支持粘贴 auth code。这是通过向 `<input>` 添加 `paste` 事件侦听器并使用 `event.clipboardData.getData('text')` 获取剪贴板值来完成的。应该对剪贴板值进行验证，以确保粘贴的值有效，如果是，则相应地填充输入字段。

当前的实现从开始就替换值，而不管哪个输入字段接收到粘贴事件。因此，不可能通过粘贴代码的其余部分来完成部分填充的组件的代码。

这种行为可能不是最理想的，但考虑到以下几点，是可以接受的：

1. 当验证码被复制时，它通常是整个代码。
2. 通常，当焦点位于第一个输入字段时，会粘贴验证码。

<TestCases />

<A11y />
